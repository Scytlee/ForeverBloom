@page "/kategoria/{slug}/{pageNumber:int?}"
@using ForeverBloom.Domain.Shared.Models
@model CategoryPageModel

<div id="category-root">
  @if (Model.ErrorMessage is not null)
  {
    <div class="container">
      <div class="alert alert-danger mt-3" role="alert"><strong>Błąd:</strong> @Model.ErrorMessage</div>
    </div>
  }

  <!-- Full-width header with background image, no top padding -->
  <header class="category-hero">
    <div class="category-hero-bg"
         role="img"
         aria-label="Tło kategorii"
         style="--hero-image: url('@(Model.Category!.ImagePath ?? "/images/assets/category-banner.avif")')">
    </div>
    <div class="category-hero-overlay">
      <div class="container">
        <div class="text-panel">
          <nav aria-label="okruszki" class="category-breadcrumbs mb-2">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="/katalog">Katalog</a></li>
              @if (Model.Category.Breadcrumbs.Any())
              {
                foreach (var crumb in Model.Category.Breadcrumbs.SkipLast(1))
                {
                  <li class="breadcrumb-item"><a href="/kategoria/@crumb.Slug">@crumb.Name</a></li>
                }
              }
              <li class="breadcrumb-item active" aria-current="page">@Model.Category.Name</li>
            </ol>
          </nav>
          <h1 class="display-5 mb-2">@Model.Category.Name</h1>
          @if (!string.IsNullOrEmpty(Model.Category.Description))
          {
            <p class="lead mb-0">@Model.Category.Description</p>
          }
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="my-3">
      <button id="toggleCatalogBtn" class="btn btn-outline-secondary" type="button" aria-label="Ukryj katalog">Ukryj
        katalog
      </button>
    </div>
    <div id="category-layout" class="catalog-expanded">
      <aside id="categorySidebar" aria-label="Nawigacja kategorii">
        <div id="category-tree-inline">
          @{
            var activeSlug = Model.Category.Slug;
            var ancestorSlugs = new HashSet<string>(Model.Category.Breadcrumbs.Select(b => b.Slug), StringComparer.OrdinalIgnoreCase);
            var vd = new ViewDataDictionary(ViewData)
            {
              ["ActiveCategorySlug"] = activeSlug,
              ["AncestorSlugs"] = ancestorSlugs,
              ["Level"] = 0
            };
            @await Html.PartialAsync("_CategoryTreePartial", Model.CategoryTree!.Categories, vd)
          }
        </div>
      </aside>

      @* Placeholder for products; will be rebuilt next *@
      <section aria-label="Lista produktów" id="productGridCol" class="mb-3">
        <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-3">
          <div class="small text-muted">
            @if (Model.Products is { TotalCount: > 0 })
            {
              var start = ((Model.Products.PageNumber - 1) * Model.Products.PageSize) + 1;
              var end = start + (Model.Products.Items?.Count ?? 0) - 1;
              <span>Pozycje @start-@end z @Model.Products.TotalCount</span>
            }
            else
            {
              <span>Brak wyników</span>
            }
          </div>
          <form method="get" action="/kategoria/@Model.Slug" class="d-flex align-items-center gap-2">
            <label for="sortBy" class="form-label small mb-0">Sortowanie:</label>
            <select name="sortBy" id="sortBy" class="form-select form-select-sm" style="width:auto"
                    onchange="this.form.submit()">
              @foreach (var option in Model.SortingOptions)
              {
                var isSelected = string.IsNullOrEmpty(Model.SortBy) ? string.IsNullOrEmpty(option.Key) : Model.SortBy == option.Key;
                <option value="@option.Key" selected="@isSelected">@option.Value</option>
              }
            </select>
          </form>
        </div>

        @if (Model.Products?.Items?.Any() == true)
        {
          <div class="row g-4">
            @foreach (var product in Model.Products.Items)
            {
              <div class="col-12 col-md-6 col-xl-4">
                @{
                  var dimCard = product.Availability is ProductAvailabilityStatus.OutOfStock or ProductAvailabilityStatus.Discontinued or ProductAvailabilityStatus.ComingSoon;
                  var cardClasses = $"card h-100 product-card position-relative{(dimCard ? " dimmed" : string.Empty)}";
                }
                <div class="@cardClasses">
                  <div class="product-card-img bg-light">
                    <img
                      src="@(string.IsNullOrWhiteSpace(product.PrimaryImagePath) ? "/images/assets/no-image.png" : product.PrimaryImagePath)"
                      alt="@product.Name"
                      loading="lazy"
                    />
                  </div>
                  <div class="card-body">
                    <h3 class="h6 card-title mb-1 text-truncate" title="@product.Name">@product.Name</h3>
                    @if (!string.IsNullOrWhiteSpace(product.MetaDescription))
                    {
                      <p class="card-text text-muted small line-clamp-2 mb-2">@product.MetaDescription</p>
                    }
                    <a class="stretched-link" href="/produkt/@product.Slug" aria-label="Zobacz @product.Name"></a>
                  </div>
                  <div class="card-footer bg-transparent border-0 pt-0">
                    <div class="d-flex align-items-center justify-content-between gap-2 product-meta-row">
                      <div class="d-flex align-items-center gap-2">
                        @{
                          var showNumericPrice = false;
                          var showInquireLabel = false;
                          switch (product.Availability)
                          {
                            case ProductAvailabilityStatus.Available:
                              showNumericPrice = product.Price.HasValue;
                              showInquireLabel = !product.Price.HasValue;
                              break;
                            case ProductAvailabilityStatus.OutOfStock:
                              showNumericPrice = product.Price.HasValue;
                              break;
                            case ProductAvailabilityStatus.MadeToOrder:
                              showNumericPrice = product.Price.HasValue;
                              showInquireLabel = !product.Price.HasValue;
                              break;
                            case ProductAvailabilityStatus.Discontinued:
                            case ProductAvailabilityStatus.ComingSoon:
                            default:
                              break;
                          }

                          if (showNumericPrice)
                          {
                            <span class="fw-semibold">@product.Price!.Value.ToString("C")</span>
                          }
                          else if (showInquireLabel)
                          {
                            <span class="text-muted">Zapytaj o cenę</span>
                          }
                        }
                      </div>

                      <div class="d-flex align-items-center gap-2">
                        @switch (product.Availability)
                        {
                          case ProductAvailabilityStatus.OutOfStock:
                            <span class="badge text-bg-secondary">Chwilowo niedostępny</span>
                            break;
                          case ProductAvailabilityStatus.MadeToOrder:
                            <span class="badge text-bg-warning">Na zamówienie</span>
                            break;
                          case ProductAvailabilityStatus.Discontinued:
                            <span class="badge text-bg-dark">Niedostępny</span>
                            break;
                          case ProductAvailabilityStatus.ComingSoon:
                            <span class="badge border border-primary text-primary">Wkrótce</span>
                            break;
                        }
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>

          @if (Model.Products.TotalPages > 1)
          {
            <nav aria-label="Stronicowanie" class="mt-4">
              <ul class="pagination pagination-sm justify-content-center align-items-center mb-2">
                @{
                  var isFirst = Model.Products.PageNumber == 1;
                  var isLast = Model.Products.PageNumber == Model.Products.TotalPages;
                }
                <li class="page-item @(isFirst ? "disabled" : null)">
                  <a class="page-link" asp-page="/Category" asp-route-slug="@Model.Slug"
                     asp-route-sortBy="@Model.SortBy" asp-route-pageNumber="1" aria-label="Pierwsza"><i
                      class="fa-solid fa-angles-left" aria-hidden="true"></i></a>
                </li>
                <li class="page-item @(Model.Products.HasPreviousPage ? null : "disabled")">
                  <a class="page-link" asp-page="/Category" asp-route-slug="@Model.Slug"
                     asp-route-sortBy="@Model.SortBy" asp-route-pageNumber="@(Model.Products.PageNumber - 1)"
                     aria-label="Poprzednia"><i class="fa-solid fa-angle-left" aria-hidden="true"></i></a>
                </li>
                <li class="page-item disabled"><span
                    class="page-link">@Model.Products.PageNumber / @Model.Products.TotalPages</span></li>
                <li class="page-item @(Model.Products.HasNextPage ? null : "disabled")">
                  <a class="page-link" asp-page="/Category" asp-route-slug="@Model.Slug"
                     asp-route-sortBy="@Model.SortBy" asp-route-pageNumber="@(Model.Products.PageNumber + 1)"
                     aria-label="Następna"><i class="fa-solid fa-angle-right" aria-hidden="true"></i></a>
                </li>
                <li class="page-item @(isLast ? "disabled" : null)">
                  <a class="page-link" asp-page="/Category" asp-route-slug="@Model.Slug"
                     asp-route-sortBy="@Model.SortBy" asp-route-pageNumber="@Model.Products.TotalPages"
                     aria-label="Ostatnia"><i class="fa-solid fa-angles-right" aria-hidden="true"></i></a>
                </li>
              </ul>

            </nav>
          }
        }
        else
        {
          <div class="text-center py-5" role="status">
            <p class="mb-0">Brak produktów</p>
          </div>
        }
      </section>
    </div>
  </div>

  <script>
    (function () {
      const btn = document.getElementById('toggleCatalogBtn');
      const layout = document.getElementById('category-layout');
      if (!btn || !layout) return;

      function setState(collapsed) {
        if (collapsed) {
          layout.classList.add('catalog-collapsed');
          btn.textContent = 'Pokaż katalog';
          btn.setAttribute('aria-label', 'Pokaż katalog');
          btn.setAttribute('aria-expanded', 'false');
        } else {
          layout.classList.remove('catalog-collapsed');
          btn.textContent = 'Ukryj katalog';
          btn.setAttribute('aria-label', 'Ukryj katalog');
          btn.setAttribute('aria-expanded', 'true');
        }
      }

      // Start expanded
      setState(false);
      btn.addEventListener('click', function () {
        const willCollapse = !layout.classList.contains('catalog-collapsed');
        setState(willCollapse);
      });
    })();
  </script>
</div>
