@page "/produkt/{slug}"
@using ForeverBloom.Domain.Shared.Models
@model ForeverBloom.Frontend.RazorPages.Pages.ProductPageModel

@{
  var product = Model.Product;
  var images = new List<(string ImagePath, string AltText)>();
  if (product?.Images?.Any() == true)
  {
    foreach (var img in product.Images.OrderBy(i => i.DisplayOrder))
    {
      images.Add((img.ImagePath, string.IsNullOrWhiteSpace(img.AltText) ? product.Name : img.AltText!));
    }
  }

  var carouselId = $"productCarousel-{product?.Id ?? 0}";
}

<div class="container mt-3 mt-lg-4">
  @if (!string.IsNullOrEmpty(Model.ErrorMessage))
  {
    <div class="alert alert-danger" role="alert">
      <strong>Błąd:</strong> @Model.ErrorMessage
    </div>
  }

  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/katalog" class="text-decoration-none">Katalog</a></li>
      <li class="breadcrumb-item active" aria-current="page">@product!.Name</li>
    </ol>
  </nav>

  <div class="row g-4">
    <!-- Gallery with thumbnails or fallback -->
    <div class="col-12 col-lg-6">
      <div class="position-relative">
        @if (images.Count > 0)
        {
          <div id="@carouselId" class="carousel slide" data-bs-ride="false" aria-label="Galeria produktu">
            <div class="carousel-inner" style="height:520px;">
              @for (int i = 0; i < images.Count; i++)
              {
                var (path, alt) = images[i];
                <div class="carousel-item h-100 @(i == 0 ? "active" : null)">
                  <img src="@path" class="d-block w-100 h-100" alt="@alt" style="object-fit:contain;"/>
                </div>
              }
            </div>

            @if (images.Count > 1)
            {
              <button class="carousel-control-prev carousel-control-overlay" type="button" data-bs-target="#@carouselId"
                      data-bs-slide="prev" aria-label="Poprzednie zdjęcie">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Poprzednie</span>
              </button>
              <button class="carousel-control-next carousel-control-overlay" type="button" data-bs-target="#@carouselId"
                      data-bs-slide="next" aria-label="Następne zdjęcie">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Następne</span>
              </button>
            }
          </div>

          @if (images.Count > 1)
          {
            <div class="mt-3 h-scroll-wrapper">
              <button type="button"
                      class="btn btn-light shadow-sm d-md-inline-flex h-scroll-btn h-scroll-btn-left h-scroll-btn-hidden"
                      aria-label="Przewiń miniatury w lewo">
                <i class="fa-solid fa-angle-left" aria-hidden="true"></i>
              </button>
              <div class="h-scroll justify-content-center gap-2" tabindex="0" role="group"
                   aria-label="Miniatury galerii">
                @for (int i = 0; i < images.Count; i++)
                {
                  var (path, alt) = images[i];
                  <button type="button"
                          class="btn p-0 thumb-btn"
                          data-bs-target="#@carouselId"
                          data-bs-slide-to="@i"
                          aria-label="Podgląd: @alt"
                          aria-current="@(i == 0 ? "true" : null)">
                    <img src="@path" class="img-thumbnail thumb-img" alt="@alt"/>
                  </button>
                }
              </div>
              <button type="button"
                      class="btn btn-light shadow-sm d-md-inline-flex h-scroll-btn h-scroll-btn-right h-scroll-btn-hidden"
                      aria-label="Przewiń miniatury w prawo">
                <i class="fa-solid fa-angle-right" aria-hidden="true"></i>
              </button>
            </div>
          }
        }
        else
        {
          <div class="no-image-fallback">
            <img src="/images/assets/no-image.png" alt="Brak zdjęcia"/>
          </div>
        }
      </div>
    </div>

    <!-- Details -->
    <div class="col-12 col-lg-6">
      <h1 class="display-6 mb-0">@product.Name</h1>
      <div class="mt-2 mb-3">
        @switch (product.Availability)
        {
          case ProductAvailabilityStatus.OutOfStock:
            <span class="badge text-bg-secondary rounded-pill fs-6">Chwilowo niedostępny</span>
            break;
          case ProductAvailabilityStatus.MadeToOrder:
            <span class="badge text-bg-warning rounded-pill fs-6">Na zamówienie</span>
            break;
          // InquireForPrice: intentionally no badge
          case ProductAvailabilityStatus.Discontinued:
            <span class="badge text-bg-dark rounded-pill fs-6">Niedostępny</span>
            break;
          case ProductAvailabilityStatus.ComingSoon:
            <span class="badge border border-primary text-primary rounded-pill fs-6">Wkrótce</span>
            break;
        }
      </div>
      @{
        bool showNumericPrice = false;
        bool showInquireLabel = false;
        bool showContactCta = product.Availability != ProductAvailabilityStatus.OutOfStock
                              && product.Availability != ProductAvailabilityStatus.Discontinued
                              && product.Availability != ProductAvailabilityStatus.ComingSoon;
        switch (product.Availability)
        {
          case ProductAvailabilityStatus.Available:
            showNumericPrice = product.Price.HasValue;
            showInquireLabel = !product.Price.HasValue;
            break;
          case ProductAvailabilityStatus.OutOfStock:
            showNumericPrice = product.Price.HasValue;
            break;
          case ProductAvailabilityStatus.MadeToOrder:
            showNumericPrice = product.Price.HasValue;
            showInquireLabel = !product.Price.HasValue;
            break;
          case ProductAvailabilityStatus.Discontinued:
          case ProductAvailabilityStatus.ComingSoon:
          default:
            break;
        }
      }
      @if (showNumericPrice || showInquireLabel)
      {
        <div class="d-flex align-items-center gap-3 mb-3">
          @if (showNumericPrice)
          {
            <span class="fs-4 fw-semibold mb-0">@product.Price!.Value.ToString("C")</span>
          }
          else
          {
            <span class="fs-5 text-muted mb-0">Zapytaj o cenę</span>
          }
        </div>
      }

      @if (!string.IsNullOrWhiteSpace(product.FullDescription))
      {
        <div class="mt-2">
          @Html.Raw(product.FullDescription)
        </div>
      }

      @if (showContactCta)
      {
        <p>Jeżeli chcesz złożyć zamówienie, skontaktuj się z nami:</p>
        <div class="d-flex align-items-center gap-3 mb-3">
          <a class="btn btn-primary" asp-page="/Contact" role="button">Kontakt</a>
        </div>
      }
    </div>
  </div>
</div>

@section Scripts {
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var carouselEl = document.getElementById('@carouselId');
      if (!carouselEl) return;
      carouselEl.addEventListener('slid.bs.carousel', function (e) {
        var index = e.to;
        document.querySelectorAll('#@carouselId ~ .h-scroll-wrapper [data-bs-slide-to]').forEach(function (btn) {
          btn.setAttribute('aria-current', btn.getAttribute('data-bs-slide-to') === String(index) ? 'true' : 'false');
        });
      });

      // Horizontal scroll controls for thumbs (desktop)
      var wrapper = carouselEl.parentElement?.querySelector('.h-scroll-wrapper');
      if (!wrapper) return;
      var scroller = wrapper.querySelector('.h-scroll');
      var btnLeft = wrapper.querySelector('.h-scroll-btn-left');
      var btnRight = wrapper.querySelector('.h-scroll-btn-right');
      if (scroller && btnLeft && btnRight) {
        var updateNavVisibility = function () {
          var hasOverflow = (scroller.scrollWidth - scroller.clientWidth) > 1; // tolerance
          if (hasOverflow) {
            btnLeft.classList.remove('h-scroll-btn-hidden');
            btnRight.classList.remove('h-scroll-btn-hidden');
            // align items to start when we can scroll
            scroller.classList.remove('justify-content-center');
            scroller.classList.add('justify-content-start');
          } else {
            btnLeft.classList.add('h-scroll-btn-hidden');
            btnRight.classList.add('h-scroll-btn-hidden');
            // center thumbnails horizontally when no overflow
            scroller.classList.remove('justify-content-start');
            scroller.classList.add('justify-content-center');
          }
        };
        var scrollBy = function (dir) {
          var amount = Math.max(scroller.clientWidth * 0.8, 200);
          scroller.scrollBy({left: dir * amount, behavior: 'smooth'});
        };
        btnLeft.addEventListener('click', function () {
          scrollBy(-1);
        });
        btnRight.addEventListener('click', function () {
          scrollBy(1);
        });
        // run after images load to compute correct widths
        if (document.readyState === 'complete') {
          updateNavVisibility();
        } else {
          window.addEventListener('load', updateNavVisibility);
        }
        // also observe size changes
        if (window.ResizeObserver) {
          var ro = new ResizeObserver(updateNavVisibility);
          ro.observe(scroller);
        }
        window.addEventListener('resize', updateNavVisibility);
      }
    });
  </script>
}
