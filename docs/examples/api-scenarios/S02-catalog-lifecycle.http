# @import ./_common.http

{{
    exports.runId = Math.random().toString(36).slice(2, 8);
}}

###
# Scenario: Product lifecycle â€” create, read publicly, update slug with concurrency, and browse listings

### 1) Create a category first (admin)
# @name createCategory
# @title Create category
# @description Creates a category for the product lifecycle demo
POST {{base}}/admin/categories
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "name": "Product Lifecycle Demo Category {{runId}}",
  "slug": "product-lifecycle-demo-{{runId}}",
  "description": "Category for product lifecycle scenario",
  "parentCategoryId": null
}

?? status == 201

{{
  exports.categoryId = response.parsedBody.id;
  exports.categorySlug = response.parsedBody.slug;
  exports.categoryRowVersion = response.parsedBody.rowVersion;
}}

### 2) Create a product (admin)
# @ref createCategory
# @name createProduct
# @title Create product
# @description Creates a product with initial slug
POST {{base}}/admin/products
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "name": "Leather Belt {{runId}}",
  "slug": "leather-belt-{{runId}}",
  "categoryId": {{categoryId}},
  "price": 39.99,
  "publishStatus": 2
}

?? status == 201

{{
  exports.productId = response.parsedBody.id;
  exports.productSlug = response.parsedBody.slug;
  exports.productRowVersion = response.parsedBody.rowVersion;
}}

### 3) Get product by slug (public)
# @ref createProduct
# @title Get product by slug
# @description Retrieves product using its initial slug
GET {{base}}/products/{{productSlug}}
Accept: application/json
X-Api-Key: {{frontendKey}}

?? status == 200

### 4) Update product slug (admin, PATCH w/ concurrency)
# @ref createProduct
# @name updateProductSlug
# @title Update product slug
# @description Updates the product slug with concurrency control
PATCH {{base}}/admin/products/{{productId}}
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "slug": "leather-belt-matte-{{runId}}",
  "rowVersion": {{productRowVersion}}
}

?? status == 200

{{
  exports.oldProductSlug = productSlug;
  exports.productSlug = response.parsedBody.slug;
  exports.productRowVersion = response.parsedBody.rowVersion;
}}

### 5) Expect 301 from old slug (public)
# @ref updateProductSlug
# @no-redirect
# @title Test old slug redirect
# @description Verifies that old slug redirects with 301 status
GET {{base}}/products/{{oldProductSlug}}
Accept: application/json
X-Api-Key: {{frontendKey}}

?? status == 301

### 6) Read with the new slug (public)
# @ref updateProductSlug
# @title Get product by new slug
# @description Retrieves product using the updated slug
GET {{base}}/products/{{productSlug}}
Accept: application/json
X-Api-Key: {{frontendKey}}

?? status == 200

### 7) List products with paging, sorting, and filters (public)
# @ref updateProductSlug
# @title List products with filters
# @description Tests pagination, sorting, and filtering capabilities
@pageNumber = 1
@pageSize = 10
{{
  exports.orderByEnc = encodeURIComponent("Name asc, Price desc");
}}
GET {{base}}/products?pageNumber={{pageNumber}}&pageSize={{pageSize}}&orderBy={{orderByEnc}}&categoryId={{categoryId}}&includeSubcategories=true&searchTerm=belt
Accept: application/json
X-Api-Key: {{frontendKey}}

?? status == 200

### 8) Archive product (admin)
# @ref updateProductSlug
# @name archiveProduct
# @title Archive product
# @description Archives the product before deletion
POST {{base}}/admin/products/{{productId}}/archive
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "rowVersion": {{productRowVersion}}
}

?? status == 200

{{
  exports.productRowVersion = response.parsedBody.rowVersion;
}}

### 9) Delete product (admin)
# @ref archiveProduct
# @name deleteProduct
# @title Delete product
# @description Deletes the archived product with concurrency check
DELETE {{base}}/admin/products/{{productId}}?rowVersion={{productRowVersion}}
Accept: application/json
X-Api-Key: {{adminKey}}

?? status == 204

### 10) Verify product is deleted (public)
# @ref deleteProduct
# @title Verify product deletion
# @description Confirms that product no longer exists
GET {{base}}/products/{{productSlug}}
Accept: application/json
X-Api-Key: {{frontendKey}}

?? status == 404

### 11) Archive category for restoration (admin)
# @ref deleteProduct
# @name archiveCategoryForRestoration
# @title Archive category for restoration
# @description Archives the category to test restore functionality
POST {{base}}/admin/categories/{{categoryId}}/archive
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "rowVersion": {{categoryRowVersion}}
}

?? status == 200

{{
  exports.categoryRowVersion = response.parsedBody.rowVersion;
}}

### 12) Restore category (admin)
# @ref archiveCategoryForRestoration
# @name restoreCategory
# @title Restore category
# @description Restores the archived category
POST {{base}}/admin/categories/{{categoryId}}/restore
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "rowVersion": {{categoryRowVersion}}
}

?? status == 200

{{
  exports.categoryRowVersion = response.parsedBody.rowVersion;
}}

### 13) Archive category for deletion (admin)
# @ref restoreCategory
# @name archiveCategoryForDeletion
# @title Archive category for deletion
# @description Archives the category before final deletion
POST {{base}}/admin/categories/{{categoryId}}/archive
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "rowVersion": {{categoryRowVersion}}
}

?? status == 200

{{
  exports.categoryRowVersion = response.parsedBody.rowVersion;
}}

### 14) Delete category (admin)
# @ref archiveCategoryForDeletion
# @title Delete category
# @description Deletes the archived category
DELETE {{base}}/admin/categories/{{categoryId}}?rowVersion={{categoryRowVersion}}
Accept: application/json
X-Api-Key: {{adminKey}}

?? status == 204
