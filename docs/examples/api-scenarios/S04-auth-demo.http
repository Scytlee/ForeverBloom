# @import ./_common.http

{{
    exports.runId = Math.random().toString(36).slice(2, 8);
}}

###
# Scenario: Auth demo — 401, 403, and 200 across public/admin endpoints

### Setup: Create test resources

### 1) Create a category (admin)
# @name createCategory
# @title Create category for auth demo
# @description Creates a category for auth testing
POST {{base}}/admin/categories
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "name": "Auth Demo Category {{runId}}",
  "slug": "auth-demo-category-{{runId}}",
  "description": "Category for auth demo scenario",
  "parentCategoryId": null
}

?? status == 201

{{
  exports.categoryId = response.parsedBody.id;
  exports.categorySlug = response.parsedBody.slug;
  exports.categoryRowVersion = response.parsedBody.rowVersion;
}}

### 2) Create a product (admin)
# @ref createCategory
# @name createProduct
# @title Create product for auth demo
# @description Creates a product for auth testing
POST {{base}}/admin/products
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "name": "Auth Demo Product {{runId}}",
  "slug": "auth-demo-product-{{runId}}",
  "categoryId": {{categoryId}},
  "price": 19.99,
  "publishStatus": 2
}

?? status == 201

{{
  exports.productId = response.parsedBody.id;
  exports.productSlug = response.parsedBody.slug;
  exports.productRowVersion = response.parsedBody.rowVersion;
}}

### Auth matrix tests

### 3) Public product without API key → 401 Unauthorized
# @ref createProduct
# @title Public endpoint without key (401)
# @description Tests that public endpoint requires authentication
GET {{base}}/products/{{productSlug}}
Accept: application/json

?? status == 401

### 4) Public product with frontend key → 200 OK
# @ref createProduct
# @title Public endpoint with frontend key (200)
# @description Tests that frontend key grants access to public endpoints
GET {{base}}/products/{{productSlug}}
Accept: application/json
X-Api-Key: {{frontendKey}}

?? status == 200

### 5) Public product with admin key → 200 OK
# @ref createProduct
# @title Public endpoint with admin key (200)
# @description Tests that admin key also grants access to public endpoints
GET {{base}}/products/{{productSlug}}
Accept: application/json
X-Api-Key: {{adminKey}}

?? status == 200

### 6) Admin get product with frontend key → 403 Forbidden
# @ref createProduct
# @title Admin endpoint with frontend key (403)
# @description Tests that frontend key is forbidden from admin endpoints
GET {{base}}/admin/products/{{productId}}
Accept: application/json
X-Api-Key: {{frontendKey}}

?? status == 403

### 7) Admin get product with admin key → 200 OK
# @ref createProduct
# @title Admin endpoint with admin key (200)
# @description Tests that admin key grants access to admin endpoints
GET {{base}}/admin/products/{{productId}}
Accept: application/json
X-Api-Key: {{adminKey}}

?? status == 200

### Cleanup: Delete test resources

### 8) Archive product (admin)
# @ref createProduct
# @name archiveProduct
# @title Archive product
# @description Archives the product before deletion
POST {{base}}/admin/products/{{productId}}/archive
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "rowVersion": {{productRowVersion}}
}

?? status == 200

{{
  exports.productRowVersion = response.parsedBody.rowVersion;
}}

### 9) Delete product (admin)
# @ref archiveProduct
# @title Delete product
# @description Deletes the archived product
DELETE {{base}}/admin/products/{{productId}}?rowVersion={{productRowVersion}}
Accept: application/json
X-Api-Key: {{adminKey}}

?? status == 204

### 10) Archive category (admin)
# @ref createCategory
# @name archiveCategory
# @title Archive category
# @description Archives the category before deletion
POST {{base}}/admin/categories/{{categoryId}}/archive
Accept: application/json
Content-Type: application/json
X-Api-Key: {{adminKey}}

{
  "rowVersion": {{categoryRowVersion}}
}

?? status == 200

{{
  exports.categoryRowVersion = response.parsedBody.rowVersion;
}}

### 11) Delete category (admin)
# @ref archiveCategory
# @title Delete category
# @description Deletes the archived category
DELETE {{base}}/admin/categories/{{categoryId}}?rowVersion={{categoryRowVersion}}
Accept: application/json
X-Api-Key: {{adminKey}}

?? status == 204
